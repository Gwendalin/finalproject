<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2D Design Working Space</title>
    <!-- Bootstrap JS and dependencies -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <!-- Include Bootstrap 3 CSS for Glyphicons -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <!-- CSS -->
    <link href="{% static '/css/2d_sketch.css' %}" rel="stylesheet">
    <!-- Fabric.js -->
    <script src="https://cdn.jsdelivr.net/npm/fabric@latest/dist/index.min.js"></script>
</head>
<body>

<div class="d-flex">
    <!-- Sidebar -->
    <div class="sidebar d-flex flex-column p-3">
        <div class="logo-container">
            <a href="{% url 'user_home' %}"><img src="{% static '/image/logo.jpg' %}" alt="Logo"></a>
        </div>
        <a href="{% url 'user_home' %}" style=" color: black; text-decoration: none;"><i class="back bi bi-arrow-left"></i></a>
        <i class="bi bi-arrow-counterclockwise" id="undo"></i>
        <button id="drag-mode" class="btn btn-outline-dark">Drag</button>
        <button id="free-draw" class="btn btn-outline-dark">Drawing</button>
        <button id="line-mode" class="btn btn-outline-dark">Line</button>
        <button id="rectangle-mode" class="btn btn-outline-dark">Rectangle</button>
        <button id="circle-mode" class="btn btn-outline-dark">Circle</button>
        <button id="eraser-mode" class="btn btn-outline-dark">Eraser</button>
        <input type="range" id="eraser-size" class="slider-margin" min="5" max="50" value="5" step="1">
        <span id="eraser-size-value">5</span>
        <button id="color-picker-button" class="btn btn-outline-dark">Color Picker</button>
        <span id="current-color" style="background-color: #000000;"></span>
        <input type="color" id="hidden-color-picker" class="d-none">
        <button id="clear-canvas" class="btn btn-outline-danger">Clear Canvas</button>
        <div class="operational-btn">
            <input type="file" id="imageInput" class="btn btn-primary" style="display: none;" />
            <button onclick="" class="btn btn-outline-primary">Open File</button>
            <button onclick="" class="btn btn-outline-primary">Save as Image</button>
            <button onclick="" class="btn btn-outline-primary">Save Design State</button> 
        </div>
        
    </div>

    <div class="canvas-container">
        <canvas id="designCanvas"></canvas>
    </div>
</div>

<script>
    // Initialize Fabric.js Canvas
    const canvas = new fabric.Canvas('designCanvas', {
        height: window.innerHeight - 100,
        width: window.innerWidth - 20,
    });

    let drawingType = ''; // Keeps track of the selected tool
    let currentShape = null; // The shape being drawn
    let controlPoints = []; // Draggable control points for curves
    let lineObject = null;
    let curvePath = null;

    // Line button click event
    document.getElementById('line-mode').addEventListener('click', () => {
        console.log('Line drawing mode activated');
        startLineDrawing();
    });

    // Start line drawing mode
    function startLineDrawing() {
        drawingType = 'line';
        console.log('Start drawing a line');
    }

    // Mouse down event: Start drawing or interacting with shapes
    canvas.on('mouse:down', (e) => {
        const pointer = canvas.getPointer(e.e);
        console.log('Mouse down at:', pointer);

        if (drawingType === 'line' && !currentShape) {
            // Create the line on mouse down
            currentShape = new fabric.Line([pointer.x, pointer.y, pointer.x, pointer.y], {
                stroke: 'black',
                strokeWidth: 2,
                selectable: true, // Allow selection for interaction
                hasBorders: false,
                hasControls: false,
            });
            canvas.add(currentShape);
            console.log('Line created:', currentShape);
        } else if (!drawingType) {
            // Handle clicks on existing objects (like the line)
            const clickedObject = canvas.findTarget(e.e); // Get the clicked object
            console.log('Clicked Object:', clickedObject);

            if (clickedObject && clickedObject === lineObject) {
                console.log('Line clicked. Ready for transformation.');
            }
        }
    });

    // Mouse move event: Update line's endpoint
    canvas.on('mouse:move', (e) => {
        if (drawingType === 'line' && currentShape) {
            const pointer = canvas.getPointer(e.e);
            currentShape.set({ x2: pointer.x, y2: pointer.y });
            canvas.renderAll();
            console.log('Line updated to:', pointer);
        }
    });

    // Mouse up event: Finalize line
    canvas.on('mouse:up', () => {
        if (drawingType === 'line' && currentShape) {
            currentShape.set({ selectable: true }); // Ensure line is selectable
            lineObject = currentShape; // Save the line as a reference
            console.log('Line finalized:', lineObject);
            currentShape = null; 
            drawingType = ''; // Reset drawing type
        }
    });

    // Transform line into cubic Bézier curve only when control points are moved
    function transformToCurve(line) {
        console.log('Transforming line to curve:', line);

        const { x1, y1, x2, y2 } = line;

        // Define initial control points
        const controlX1 = x1 + (x2 - x1) / 3;
        const controlY1 = y1; // Start flat
        const controlX2 = x1 + 2 * (x2 - x1) / 3;
        const controlY2 = y1; // Start flat

        // Create cubic Bézier curve
        curvePath = new fabric.Path(`M ${x1} ${y1} C ${controlX1} ${controlY1} ${controlX2} ${controlY2} ${x2} ${y2}`, {
            stroke: 'black',
            strokeWidth: 2,
            fill: '',
            selectable: false, // Disable selection for the curve
            opacity: 1,
        });

        canvas.remove(line);
        canvas.add(curvePath);
        console.log('Curve path added:', curvePath);

        // Create draggable control points
        const startPoint = createControlPoint(x1, y1, updateCurve);
        const controlPoint1 = createControlPoint(controlX1, controlY1, updateCurve);
        const controlPoint2 = createControlPoint(controlX2, controlY2, updateCurve);
        const endPoint = createControlPoint(x2, y2, updateCurve);

        controlPoints = [startPoint, controlPoint1, controlPoint2, endPoint];

        // Bring control points to the front
        controlPoints.forEach(point => canvas.bringToFront(point));
        canvas.renderAll();
    }

    // Create draggable control points
    function createControlPoint(x, y, callback) {
        const controlPoint = new fabric.Circle({
            left: x - 5, // Offset by radius
            top: y - 5,  // Offset by radius
            radius: 5,
            fill: 'red',
            selectable: true,
            hasBorders: false,
            hasControls: false,
        });

        controlPoint.on('moving', function () {
            // Ensure the line is transformed to a curve only once
            if (!curvePath) {
                console.log('Creating curve from line...');
                transformToCurve(lineObject); // Transform the line to a curve
            }
            // Update the curve dynamically
            callback();
        });

        canvas.add(controlPoint);
        return controlPoint;
    }

    // Update the cubic Bézier curve dynamically as control points move
    function updateCurve() {
        if (controlPoints.length !== 4) return;

        const [startPoint, controlPoint1, controlPoint2, endPoint] = controlPoints;

        console.log('Updating curve with points:');
        console.log('Start Point:', startPoint.left + 5, startPoint.top + 5);
        console.log('Control Point 1:', controlPoint1.left + 5, controlPoint1.top + 5);
        console.log('Control Point 2:', controlPoint2.left + 5, controlPoint2.top + 5);
        console.log('End Point:', endPoint.left + 5, endPoint.top + 5);

        const newPath = `M ${startPoint.left + 5} ${startPoint.top + 5} C ${controlPoint1.left + 5} ${controlPoint1.top + 5} ${controlPoint2.left + 5} ${controlPoint2.top + 5} ${endPoint.left + 5} ${endPoint.top + 5}`;
        const curvePath = canvas.getObjects().find(obj => obj.type === 'path');
        if (!curvePath) {
            console.error('Curve path not found');
            return;
        }
        curvePath.set({ path: newPath });

        canvas.renderAll();
    }
</script>

</body>
</html>
  